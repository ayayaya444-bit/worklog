<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <title>工作紀錄 Pro | v7.0</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        :root { 
            --safe-top: env(safe-area-inset-top);
            --safe-bottom: env(safe-area-inset-bottom);
            --header-height: 72px;
        }

        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: #f8fafc; 
            min-height: 100vh;
            /* 預留頂部固定欄位的高度 + 系統狀態欄高度 */
            padding-top: calc(var(--header-height) + var(--safe-top)); 
        }

        /* 修正後的固定頂部橫幅 */
        .fixed-header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(var(--header-height) + var(--safe-top));
            padding-top: var(--safe-top);
            background: rgba(15, 23, 42, 0.9); /* slate-900 帶透明度 */
            backdrop-filter: blur(12px);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding-left: 1.25rem;
            padding-right: 1.25rem;
            border-bottom: 1px solid rgba(255,255,255,0.1);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

        .iphone-nav { 
            position: fixed; 
            bottom: 0; 
            left: 0; 
            right: 0; 
            background: rgba(255, 255, 255, 0.9); 
            backdrop-filter: blur(20px); 
            border-top: 1px solid rgba(0, 0, 0, 0.05); 
            padding-bottom: var(--safe-bottom); 
            z-index: 100; 
            display: flex; 
            height: calc(70px + var(--safe-bottom)); 
        }

        .nav-btn { flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center; position: relative; }
        .active-tab-btn { color: #2563eb !important; }
        .active-tab-btn::after { content: ''; position: absolute; bottom: 12px; width: 4px; height: 4px; background: #2563eb; border-radius: 50%; }
        
        input, select, textarea { font-size: 16px !important; border-radius: 0.75rem; box-sizing: border-box !important; }
        .content-container { padding-bottom: calc(100px + var(--safe-bottom)); }
        
        .modal-overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.5); backdrop-filter: blur(8px); z-index: 2000; display: none; align-items: center; justify-content: center; padding: 20px; }
        .modal-card { background: white; border-radius: 2rem; width: 100%; max-width: 400px; max-height: 80vh; overflow: hidden; display: flex; flex-direction: column; }
    </style>
</head>
<body class="content-container">

    <nav class="fixed-header text-white">
        <div class="flex items-center gap-3">
            <button onclick="location.reload()" class="bg-slate-800 p-2 rounded-xl border border-white/5 shadow-inner">
                <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3"><path d="M21 2v6h-6"/><path d="M3 12a9 9 0 0 1 15-6.7L21 8"/><path d="M3 22v-6h6"/><path d="M21 12a9 9 0 0 1-15 6.7L3 16"/></svg>
            </button>
            <div>
                <h1 class="text-md font-extrabold tracking-tight">紀錄系統</h1>
                <p class="text-[9px] font-bold text-blue-400 uppercase">v7.0 Fixed UI</p>
            </div>
        </div>
        <div class="bg-blue-600/20 border border-blue-500/30 px-4 py-1.5 rounded-2xl text-right">
            <p class="text-[9px] font-black text-blue-400 uppercase mb-0.5">Today Total</p>
            <p class="text-xl font-black font-mono text-white" id="navDayTotal">0.0</p>
        </div>
    </nav>

    <div class="p-4 max-w-md mx-auto">
        <div id="tab-form" class="tab-content active">
            <div id="topFrequency" class="mb-4 flex gap-2 overflow-x-auto pb-2"></div>
            <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-200">
                <div id="editBadge" class="hidden mb-4 bg-orange-50 text-orange-600 text-[10px] font-black px-3 py-2 rounded-xl border border-orange-100 flex justify-between items-center"><span>EDITING RECORD</span><button onclick="cancelEdit()" class="underline">CANCEL</button></div>
                <form id="timeForm" class="space-y-4">
                    <input type="hidden" id="editId">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1"><label class="px-1 text-[9px] font-black text-slate-400 uppercase">Client ID</label><input type="text" id="clientId" required class="w-full bg-slate-50 p-3 text-center text-sm font-bold font-mono border-0" onblur="checkAndLearn('client')"></div>
                        <div class="space-y-1"><label class="px-1 text-[9px] font-black text-slate-400 uppercase">Client Name</label><input type="text" id="clientName" class="w-full bg-slate-100 p-3 text-center text-sm text-slate-400 border-0" readonly></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1"><label class="px-1 text-[9px] font-black text-slate-400 uppercase">Case No.</label><input type="text" id="caseId" required class="w-full bg-slate-50 p-3 text-center text-sm font-bold font-mono border-0" onblur="checkAndLearn('case')"></div>
                        <div class="space-y-1"><label class="px-1 text-[9px] font-black text-slate-400 uppercase">Matter Name</label><input type="text" id="matterName" class="w-full bg-slate-100 p-3 text-center text-sm text-slate-400 border-0" readonly></div>
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div class="bg-blue-50/50 p-3 rounded-[1.5rem] flex flex-col items-center overflow-hidden border border-blue-100/30">
                            <label class="text-[9px] font-black text-blue-600 uppercase mb-1">Start</label>
                            <input type="date" id="startDate" class="w-full bg-white/80 p-2 text-xs font-bold text-center mb-1.5 border-0 shadow-sm rounded-xl">
                            <input type="time" id="startTime" class="w-full bg-white p-2 text-xs font-bold text-center border-0 shadow-sm rounded-xl">
                        </div>
                        <div class="bg-indigo-50/50 p-3 rounded-[1.5rem] flex flex-col items-center overflow-hidden border border-indigo-100/30">
                            <label class="text-[9px] font-black text-indigo-600 uppercase mb-1">End</label>
                            <input type="date" id="endDate" class="w-full bg-white/80 p-2 text-xs font-bold text-center mb-1.5 border-0 shadow-sm rounded-xl">
                            <input type="time" id="endTime" class="w-full bg-white p-2 text-xs font-bold text-center border-0 shadow-sm rounded-xl">
                        </div>
                    </div>
                    <input type="text" id="hours" readonly class="w-full bg-slate-900 text-blue-400 font-black rounded-2xl p-4 text-center text-3xl border-0" value="0.0">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1"><label class="px-1 text-[9px] font-black text-slate-400 uppercase">Work Code</label><select id="workCode" class="w-full bg-slate-50 p-3 text-center text-sm font-bold border-0"><option value="D">D</option><option value="RW">RW</option><option value="CF">CF</option></select></div>
                        <div class="space-y-1"><label class="px-1 text-[9px] font-black text-slate-400 uppercase">Case Type</label><select id="caseType" class="w-full bg-slate-50 p-3 text-center text-sm font-bold border-0"><option value="M&A">M&A</option><option value="General Corporate">General Corporate</option><option value="Corporate Financing">Corporate Financing</option><option value="Project Financing">Project Financing</option><option value="Bond Issuance">Bond Issuance</option><option value="Formosa Bond">Formosa Bond</option><option value="金融商品">金融商品</option><option value="投信投顧">投信投顧</option><option value="PE Fund">PE Fund</option><option value="金融機構併購">金融機構併購</option><option value="個人資料保護">個人資料保護</option><option value="其他">其他</option></select></div>
                    </div>
                    <textarea id="content" rows="2" class="w-full bg-slate-50 p-3 text-sm font-medium border-0" placeholder="內容說明..."></textarea>
                    <button type="submit" id="submitBtn" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black text-sm uppercase shadow-lg">Save Record</button>
                </form>
            </div>
        </div>

        <div id="tab-analysis" class="tab-content"><div class="space-y-4"><div class="bg-white p-5 rounded-[2rem] border border-slate-200 h-48"><canvas id="barChart"></canvas></div><div class="bg-white p-5 rounded-[2rem] border border-slate-200"><div class="text-center mb-2"><p class="text-[10px] font-black text-slate-400 uppercase">Case Count by Category</p></div><div class="h-64"><canvas id="pieChart"></canvas></div></div><div id="drillDownArea" class="hidden animate-fadeIn space-y-3"><div class="flex justify-between items-end px-2"><h2 id="drillDownTitle" class="text-lg font-black text-slate-800">類別明細</h2><button onclick="document.getElementById('drillDownArea').classList.add('hidden')" class="text-[10px] font-bold text-slate-400">CLOSE</button></div><div id="drillDownList" class="space-y-2 pb-10"></div></div></div></div>

        <div id="tab-list" class="tab-content">
            <div class="bg-white p-5 rounded-[2rem] shadow-sm border border-slate-200 mb-4 space-y-3">
                <div class="flex justify-between items-center mb-1"><span class="text-[10px] font-black text-slate-400 uppercase">Filters & L&L Export</span><button onclick="openIdManager()" class="text-[10px] font-black text-blue-600 uppercase px-3 py-1 bg-blue-50 rounded-lg">Manage IDs</button></div>
                <div class="grid grid-cols-2 gap-2"><input type="date" id="qStart" class="bg-slate-50 p-2 text-[10px] text-center font-bold" onchange="updateUI()"><input type="date" id="qEnd" class="bg-slate-50 p-2 text-[10px] text-center font-bold" onchange="updateUI()"></div>
                <div class="grid grid-cols-2 gap-2"><button onclick="updateUI()" class="w-full bg-slate-900 text-white py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest">Refresh</button><button onclick="exportLL()" class="w-full bg-emerald-600 text-white py-2.5 rounded-xl text-[10px] font-black uppercase tracking-widest">L&L 匯出</button></div>
            </div>
            <div id="logContainer" class="space-y-3"></div>
        </div>
    </div>

    <div class="iphone-nav">
        <button onclick="switchTab('form')" id="btn-form" class="nav-btn active-tab-btn"><span class="text-[10px] font-black uppercase">New Log</span></button>
        <button onclick="switchTab('analysis')" id="btn-analysis" class="nav-btn text-slate-400"><span class="text-[10px] font-black uppercase">Analysis</span></button>
        <button onclick="switchTab('list')" id="btn-list" class="nav-btn text-slate-400"><span class="text-[10px] font-black uppercase">Vault</span></button>
    </div>

    <script>
        const DB_KEY = 'work_logs_final'; const META_KEY = 'meta_data_v4';
        let logs = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
        let meta = JSON.parse(localStorage.getItem(META_KEY) || '{"clients":{}, "cases":{}}');
        let currentManageTab = 'client'; let pChart, bChart;

        function init() { const now = new Date(); const todayStr = now.toISOString().split('T')[0]; document.getElementById('startDate').value = todayStr; document.getElementById('endDate').value = todayStr; document.getElementById('clientId').addEventListener('input', function() { document.getElementById('clientName').value = meta.clients[this.value] || ""; }); document.getElementById('caseId').addEventListener('input', function() { document.getElementById('matterName').value = meta.cases[this.value] || ""; }); updateUI(); }

        function exportLL() {
            const qs = document.getElementById('qStart').value.replace(/-/g, '/');
            const qe = document.getElementById('qEnd').value.replace(/-/g, '/');
            if (!qs || !qe) { alert("請先選擇區間"); return; }
            const filtered = logs.filter(l => (l.sd >= qs && l.sd <= qe)).sort((a,b) => a.sd.localeCompare(b.sd));
            if (!filtered.length) { alert("無資料"); return; }

            let csv = "\uFEFF"; 
            csv += "承辦人員,工作日期,客戶代碼,案件代碼,處理時數,工作代碼,處理說明,客戶對應碼\n";
            filtered.forEach(l => {
                csv += ["CYE", l.sd.replace(/\//g, ''), `="${l.c}"`, `="${l.cn}"`, l.h.toFixed(1), l.wc, `"${l.desc.replace(/"/g, '""')}"`, ""].join(",") + "\n";
            });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `LL_Report_${qs.replace(/\//g,'')}_${qe.replace(/\//g,'')}.csv`;
            link.click();
        }

        // --- 核心邏輯補完 ---
        function switchTab(t) { document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active')); document.getElementById('tab-' + t).classList.add('active'); document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active-tab-btn')); document.getElementById('btn-' + t).classList.add('active-tab-btn'); if (t === 'analysis') renderCharts(); window.scrollTo(0,0); }
        function calc() { const d1 = document.getElementById('startDate').value, t1 = document.getElementById('startTime').value, d2 = document.getElementById('endDate').value, t2 = document.getElementById('endTime').value; if(d1 && t1 && d2 && t2) { const diff = (new Date(`${d2}T${t2}`) - new Date(`${d1}T${t1}`)) / 60000; document.getElementById('hours').value = diff >= 0 ? (Math.ceil(diff / 6) / 10).toFixed(1) : "0.0"; } }
        document.getElementById('timeForm').onsubmit = (e) => { e.preventDefault(); const editId = document.getElementById('editId').value; const logData = { sd: document.getElementById('startDate').value.replace(/-/g, '/'), ed: document.getElementById('endDate').value.replace(/-/g, '/'), s: document.getElementById('startTime').value, e: document.getElementById('endTime').value, h: parseFloat(document.getElementById('hours').value), c: document.getElementById('clientId').value.trim(), cn: document.getElementById('caseId').value.trim(), wc: document.getElementById('workCode').value, ct: document.getElementById('caseType').value, desc: document.getElementById('content').value.trim() }; if (editId) { const idx = logs.findIndex(l => l.id == editId); logs[idx] = { ...logs[idx], ...logData }; cancelEdit(); } else { logs.unshift({ id: Date.now(), ...logData }); } localStorage.setItem(DB_KEY, JSON.stringify(logs)); updateUI(); switchTab('list'); };
        function updateUI() { const now = new Date(); const todaySlash = `${now.getFullYear()}/${String(now.getMonth()+1).padStart(2,'0')}/${String(now.getDate()).padStart(2,'0')}`; document.getElementById('navDayTotal').innerText = logs.filter(l => l.sd === todaySlash).reduce((s, c) => s + c.h, 0).toFixed(1); const container = document.getElementById('logContainer'); const qs = document.getElementById('qStart').value.replace(/-/g, '/'), qe = document.getElementById('qEnd').value.replace(/-/g, '/'); const filtered = logs.filter(l => (!qs || l.sd >= qs) && (!qe || l.sd <= qe)); container.innerHTML = filtered.map(l => `<div class="bg-white rounded-2xl border border-slate-100 shadow-sm overflow-hidden mb-3"><div class="p-4 flex justify-between items-start"><div class="flex-grow pr-2"><div class="flex items-center gap-2 mb-1"><span class="text-[9px] text-blue-600 font-black px-2 py-0.5 bg-blue-50 rounded-md">${l.sd}</span></div><h3 class="font-extrabold text-slate-800 text-[11px]">${l.c} <span class="text-slate-400 font-medium">(${meta.clients[l.c] || 'N/A'})</span></h3><p class="text-[10px] text-blue-500 font-black">${l.cn}</p></div><div class="text-right"><p class="text-lg font-black font-mono text-slate-900">${l.h.toFixed(1)}</p></div></div></div>`).join(''); }
        function checkAndLearn(type) { /* ...與前版本同... */ }
        init();
    </script>
</body>
</html>
