<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工作紀錄 Pro v5</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .active-tab-btn { color: #2563eb !important; border-top: 2px solid #2563eb; }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="pb-24">

    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <div>
            <h1 class="text-lg font-bold">工作分析系統</h1>
            <p class="text-[10px] opacity-60">案號基礎統計模式</p>
        </div>
        <div class="text-right">
            <p class="text-xs opacity-70">今日累積</p>
            <p class="text-xl font-mono text-blue-400" id="navDayTotal">0.0</p>
        </div>
    </nav>

    <div class="p-4 max-w-md mx-auto">
        <div id="tab-form" class="tab-content active">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <form id="timeForm" class="space-y-4">
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">CLIENT ID 客戶編號</label>
                        <input type="text" id="clientId" list="clientHistory" required class="w-full bg-slate-50 border-0 rounded-xl p-3">
                        <datalist id="clientHistory"></datalist>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1">CASE NO. 案號</label>
                        <input type="text" id="caseId" required class="w-full bg-slate-50 border-0 rounded-xl p-3">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">START 開始</label><input type="time" id="startTime" required class="w-full bg-slate-50 border-0 rounded-xl p-3"></div>
                        <div><label class="block text-xs font-bold text-slate-500 mb-1">END 結束</label><input type="time" id="endTime" required class="w-full bg-slate-50 border-0 rounded-xl p-3"></div>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-blue-500 mb-1">HOURS 小時數</label>
                        <input type="text" id="hours" readonly class="w-full bg-blue-50 text-blue-700 font-black border-0 rounded-xl p-3 text-center text-lg">
                    </div>
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">WORK CODE</label>
                            <select id="workCode" class="w-full bg-slate-50 border-0 rounded-xl p-3">
                                <option value="D">D</option><option value="RW">RW</option><option value="CF">CF</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">TYPE 類別</label>
                            <select id="caseType" class="w-full bg-slate-50 border-0 rounded-xl p-3">
                                <option>M&A</option><option>General Corporate</option><option>Corporate Financing</option>
                                <option>Project Financing</option><option>Bond Issuance</option><option>Formosa Bond</option>
                                <option>金融商品</option><option>投信投顧</option><option>PE Fund</option>
                                <option>金融機構併購</option><option>個人資料保護</option><option>其他</option>
                            </select>
                        </div>
                    </div>
                    <div><textarea id="content" rows="2" class="w-full bg-slate-50 border-0 rounded-xl p-3" placeholder="工作內容..."></textarea></div>
                    <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg">儲存紀錄</button>
                </form>
            </div>
        </div>

        <div id="tab-analysis" class="tab-content">
            <div class="space-y-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 text-center">每月總工時趨勢</h3>
                    <div class="h-64"><canvas id="barChart"></canvas></div>
                </div>

                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 mb-1 text-center">案件類型分佈</h3>
                    <p class="text-[10px] text-slate-400 text-center mb-4">(依案號數量統計)</p>
                    <div class="h-64"><canvas id="pieChart"></canvas></div>
                </div>

                <div id="drillDownContainer" class="hidden">
                    <div class="flex justify-between items-center mb-2">
                        <h3 id="drillDownTitle" class="text-sm font-bold text-blue-600"></h3>
                        <button onclick="closeDrillDown()" class="text-xs text-slate-400">關閉細目</button>
                    </div>
                    <div id="drillDownList" class="space-y-2"></div>
                </div>
            </div>
        </div>

        <div id="tab-list" class="tab-content">
            <div class="flex gap-2 mb-4">
                <input type="text" id="searchInput" placeholder="搜尋內容..." class="flex-grow p-3 rounded-xl border-0 shadow-sm">
                <button onclick="exportCSV()" class="bg-emerald-600 text-white px-4 rounded-xl font-bold text-sm">CSV</button>
            </div>
            <div id="logContainer" class="space-y-3"></div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around py-3 shadow-lg">
        <button onclick="switchTab('form')" id="btn-form" class="flex flex-col items-center px-6 transition active-tab-btn">
            <span class="text-xs font-bold">紀錄</span>
        </button>
        <button onclick="switchTab('analysis')" id="btn-analysis" class="flex flex-col items-center px-6 text-slate-400 transition">
            <span class="text-xs font-bold">分析</span>
        </button>
        <button onclick="switchTab('list')" id="btn-list" class="flex flex-col items-center px-6 text-slate-400 transition">
            <span class="text-xs font-bold">清單</span>
        </button>
    </div>

    <script>
        let logs = JSON.parse(localStorage.getItem('work_logs_v3') || '[]');
        let clients = JSON.parse(localStorage.getItem('clients_v3') || '[]');
        let pieChart, barChart;

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            document.querySelectorAll('button[id^="btn-"]').forEach(b => b.classList.remove('active-tab-btn'));
            document.getElementById('btn-' + t).classList.add('active-tab-btn');
            if(t === 'analysis') renderCharts();
            if(t === 'list') updateUI();
        }

        function calc() {
            const s = document.getElementById('startTime').value, e = document.getElementById('endTime').value;
            if(s && e) {
                let diff = (new Date(`2000-01-01T${e}`) - new Date(`2000-01-01T${s}`)) / 60000;
                if(diff < 0) diff += 1440;
                document.getElementById('hours').value = (Math.ceil(diff / 6) / 10).toFixed(1);
            }
        }
        document.getElementById('startTime').onchange = calc;
        document.getElementById('endTime').onchange = calc;

        document.getElementById('timeForm').onsubmit = (e) => {
            e.preventDefault();
            const log = {
                id: Date.now(),
                date: new Date().toLocaleDateString('zh-TW'),
                s: document.getElementById('startTime').value,
                e: document.getElementById('endTime').value,
                h: parseFloat(document.getElementById('hours').value) || 0,
                c: document.getElementById('clientId').value.trim(),
                cn: document.getElementById('caseId').value.trim(),
                wc: document.getElementById('workCode').value,
                ct: document.getElementById('caseType').value,
                desc: document.getElementById('content').value.trim()
            };
            logs.unshift(log);
            if(log.c && !clients.includes(log.c)) clients.push(log.c);
            localStorage.setItem('work_logs_v3', JSON.stringify(logs));
            localStorage.setItem('clients_v3', JSON.stringify(clients));
            alert('已成功儲存！'); e.target.reset(); updateUI();
        };

        function renderCharts() {
            if (pieChart) pieChart.destroy();
            if (barChart) barChart.destroy();

            // --- 圓餅圖數據處理 (以案號為基礎) ---
            const caseMap = {}; // 用案號當 Key，存下該案號對應的類別
            // 從舊到新遍歷，後面的會覆蓋前面的，確保以「最新一次輸入」的類型為準
            [...logs].reverse().forEach(l => {
                if(l.cn) caseMap[l.cn] = l.ct;
            });

            const typeCounts = {};
            Object.values(caseMap).forEach(type => {
                typeCounts[type] = (typeCounts[type] || 0) + 1;
            });
            
            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'pie',
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{
                        data: Object.values(typeCounts),
                        backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#64748b', '#2dd4bf', '#fb923c']
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } }
                    },
                    onClick: (evt, item) => {
                        if (item.length > 0) {
                            const index = item[0].index;
                            showDrillDown(Object.keys(typeCounts)[index], 'pie');
                        }
                    }
                }
            });

            // --- 長條圖數據處理 (按月份) ---
            const monthData = {};
            logs.forEach(l => {
                const dateParts = l.date.split('/');
                const m = dateParts[0] + '/' + (dateParts[1].length === 1 ? '0' + dateParts[1] : dateParts[1]); // YYYY/MM
                monthData[m] = (monthData[m] || 0) + l.h;
            });

            const sortedMonths = Object.keys(monthData).sort();

            barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: {
                    labels: sortedMonths,
                    datasets: [{
                        label: '總小時數',
                        data: sortedMonths.map(m => monthData[m]),
                        backgroundColor: '#6366f1'
                    }]
                },
                options: { 
                    responsive: true, 
                    maintainAspectRatio: false,
                    scales: { y: { beginAtZero: true } }
                }
            });
        }

        function showDrillDown(label, chartType) {
            const container = document.getElementById('drillDownContainer');
            const list = document.getElementById('drillDownList');
            document.getElementById('drillDownTitle').innerText = label + ' - 案件清單';
            
            // 如果是點擊圓餅圖，顯示該類別下的所有獨特案號
            let filtered = [];
            if(chartType === 'pie') {
                const seenCases = new Set();
                filtered = logs.filter(l => {
                    if(l.ct === label && !seenCases.has(l.cn)) {
                        seenCases.add(l.cn);
                        return true;
                    }
                    return false;
                });
            }

            list.innerHTML = filtered.map(l => `
                <div class="bg-white p-3 rounded-lg border border-slate-100 text-xs">
                    <div class="flex justify-between font-bold text-slate-700">
                        <span>${l.cn}</span>
                        <span class="text-blue-500">${l.c}</span>
                    </div>
                </div>
            `).join('');
            container.classList.remove('hidden');
            window.scrollTo(0, document.body.scrollHeight);
        }

        function closeDrillDown() { document.getElementById('drillDownContainer').classList.add('hidden'); }

        function updateUI() {
            const container = document.getElementById('logContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = logs.filter(l => l.c.toLowerCase().includes(search) || l.cn.toLowerCase().includes(search) || l.desc.toLowerCase().includes(search));
            
            container.innerHTML = filtered.map(l => `
                <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 mb-3">
                    <div class="flex justify-between">
                        <div><p class="text-[10px] text-slate-400 font-bold">${l.date}</p><h3 class="font-black text-slate-800">${l.c}</h3><p class="text-xs text-blue-500">${l.cn}</p></div>
                        <div class="text-right"><p class="text-2xl font-black text-slate-900">${l.h.toFixed(1)}</p><p class="text-[10px] text-slate-400">${l.s}-${l.e}</p></div>
                    </div>
                    <p class="text-xs text-slate-500 bg-slate-50 p-2 mt-2 rounded">${l.desc || '...'}</p>
                </div>
            `).join('');

            const today = new Date().toLocaleDateString('zh-TW');
            const dayTotal = logs.filter(l => l.date === today).reduce((a, b) => a + b.h, 0);
            document.getElementById('navDayTotal').innerText = dayTotal.toFixed(1);
            document.getElementById('clientHistory').innerHTML = clients.map(c => `<option value="${c}">`).join('');
        }

        function exportCSV() {
            let csv = "\uFEFF日期,客戶,案號,小時,WorkCode,類別,內容\n";
            logs.forEach(l => { csv += `${l.date},${l.c},${l.cn},${l.h},${l.wc},${l.ct},"${l.desc.replace(/"/g, '""')}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `WorkLog_${new Date().toLocaleDateString().replace(/\//g,'-')}.csv`;
            link.click();
        }

        document.getElementById('searchInput').oninput = updateUI;
        updateUI();
    </script>
</body>
</html>
