<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Â∑•‰ΩúÁ¥ÄÈåÑ Pro | Elite Edition</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;800&display=swap');
        
        body { 
            font-family: 'Inter', -apple-system, sans-serif; 
            background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%); 
            min-height: 100vh;
        }

        /* Á£®Á†ÇÁéªÁíÉÊïàÊûú */
        .glass-nav {
            background: rgba(15, 23, 42, 0.9);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .tab-content { display: none; }
        .tab-content.active { display: block; animation: fadeIn 0.3s ease-out; }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(8px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Â∫ïÈÉ®ÊåâÈàïÁæéÂåñ */
        .nav-btn { 
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); 
            flex: 1; 
            display: flex; 
            flex-direction: column; 
            align-items: center; 
            justify-content: center; 
            border-radius: 16px;
            margin: 4px;
        }
        
        .active-tab-btn { 
            color: #2563eb !important; 
            background: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* Ëº∏ÂÖ•Ê°ÜÁæéÂåñ */
        input, select, textarea { 
            font-size: 16px !important; 
            transition: all 0.2s;
            border: 1px solid #e2e8f0 !important;
        }
        input:focus, select:focus, textarea:focus { 
            border-color: #3b82f6 !important;
            box-shadow: 0 0 0 4px rgba(59, 130, 246, 0.1) !important;
            background: white !important;
        }

        /* Êç≤Ëª∏ÁæéÂåñ */
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }

        @keyframes spin { from { transform: rotate(0deg); } to { transform: rotate(360deg); } }
        .spinning { animation: spin 0.8s cubic-bezier(0.4, 0, 0.2, 1) infinite; }
    </style>
</head>
<body class="pb-32">

    <nav class="glass-nav text-white p-4 sticky top-0 z-50 shadow-xl flex justify-between items-center rounded-b-3xl">
        <div class="flex items-center gap-3">
            <button onclick="forceRefresh()" id="refreshBtn" class="bg-slate-700/50 p-2.5 rounded-xl active:scale-90 transition border border-white/10">
                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><path d="M21 2v6h-6"></path><path d="M3 12a9 9 0 0 1 15-6.7L21 8"></path><path d="M3 22v-6h6"></path><path d="M21 12a9 9 0 0 1-15 6.7L3 16"></path></svg>
            </button>
            <div>
                <h1 class="text-lg font-extrabold tracking-tight">Â∑•‰ΩúÁ¥ÄÈåÑ Pro</h1>
                <div class="flex items-center gap-2">
                    <span class="w-1.5 h-1.5 bg-emerald-400 rounded-full animate-pulse"></span>
                    <p class="text-[10px] font-bold opacity-60 uppercase tracking-widest">v4.4 Elite</p>
                </div>
            </div>
        </div>
        <div class="bg-blue-600/20 border border-blue-400/30 px-4 py-1.5 rounded-2xl text-right">
            <p class="text-[9px] font-black text-blue-300 uppercase">Today Total</p>
            <p class="text-xl font-black font-mono text-white" id="navDayTotal">0.0</p>
        </div>
    </nav>

    <div class="p-5 max-w-md mx-auto">
        <div id="tab-form" class="tab-content active">
            <div id="topFrequency" class="mb-5 flex gap-2 overflow-x-auto pb-2 scroll-smooth"></div>
            
            <div class="bg-white/80 backdrop-blur-sm p-6 rounded-[2.5rem] shadow-xl border border-white">
                <form id="timeForm" class="space-y-5">
                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="px-2 text-[10px] font-extrabold text-slate-400 uppercase tracking-tighter">Client ID</label>
                            <input type="text" id="clientId" required class="w-full bg-slate-50/50 rounded-2xl p-3 text-center text-sm font-bold font-mono" placeholder="ID">
                        </div>
                        <div class="space-y-1">
                            <label class="px-2 text-[10px] font-extrabold text-slate-400 uppercase tracking-tighter">Client Name</label>
                            <input type="text" id="clientName" class="w-full bg-slate-100/50 rounded-2xl p-3 text-center text-sm text-slate-400" readonly placeholder="-">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div class="space-y-1">
                            <label class="px-2 text-[10px] font-extrabold text-slate-400 uppercase tracking-tighter">Case No.</label>
                            <input type="text" id="caseId" required class="w-full bg-slate-50/50 rounded-2xl p-3 text-center text-sm font-bold font-mono" placeholder="NO.">
                        </div>
                        <div class="space-y-1">
                            <label class="px-2 text-[10px] font-extrabold text-slate-400 uppercase tracking-tighter">Matter Name</label>
                            <input type="text" id="matterName" class="w-full bg-slate-100/50 rounded-2xl p-3 text-center text-sm text-slate-400" readonly placeholder="-">
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gradient-to-b from-blue-50 to-white p-3 rounded-[2rem] border border-blue-100 shadow-inner">
                            <label class="block text-[10px] font-black text-blue-600 mb-2 text-center uppercase">Start Time</label>
                            <input type="date" id="startDate" class="w-full bg-transparent p-1 text-xs text-center font-bold mb-1">
                            <input type="time" id="startTime" class="w-full bg-white rounded-xl p-2 text-sm text-center font-bold shadow-sm">
                        </div>
                        <div class="bg-gradient-to-b from-indigo-50 to-white p-3 rounded-[2rem] border border-indigo-100 shadow-inner">
                            <label class="block text-[10px] font-black text-indigo-600 mb-2 text-center uppercase">End Time</label>
                            <input type="date" id="endDate" class="w-full bg-transparent p-1 text-xs text-center font-bold mb-1">
                            <input type="time" id="endTime" class="w-full bg-white rounded-xl p-2 text-sm text-center font-bold shadow-sm">
                        </div>
                    </div>

                    <div class="relative group">
                        <div class="absolute -inset-1 bg-gradient-to-r from-blue-600 to-indigo-600 rounded-2xl blur opacity-20 group-hover:opacity-40 transition duration-1000"></div>
                        <input type="text" id="hours" readonly class="relative w-full bg-white text-blue-600 font-black rounded-2xl p-4 text-center text-3xl shadow-sm" value="0.0">
                        <span class="absolute right-4 top-1/2 -translate-y-1/2 text-[10px] font-black text-slate-300 uppercase">Hours</span>
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <select id="workCode" class="bg-slate-50/50 rounded-2xl p-4 text-center font-bold text-slate-700 appearance-none shadow-sm"><option>D</option><option>RW</option><option>CF</option></select>
                        <select id="caseType" class="bg-slate-50/50 rounded-2xl p-4 text-center font-bold text-slate-700 appearance-none shadow-sm text-xs">
                            <option>M&A</option><option>General Corporate</option><option>Corporate Financing</option><option>Project Financing</option>
                            <option>Bond Issuance</option><option>Formosa Bond</option><option>ÈáëËûçÂïÜÂìÅ</option><option>PE Fund</option><option>ÂÖ∂‰ªñ</option>
                        </select>
                    </div>

                    <textarea id="content" rows="3" class="w-full bg-slate-50/50 rounded-[1.5rem] p-4 text-sm font-medium" placeholder="Ë´ãÊèèËø∞Â∑•‰ΩúÂÖßÂÆπ..."></textarea>
                    
                    <button type="submit" class="w-full bg-slate-900 text-white py-5 rounded-[1.5rem] font-black text-sm uppercase tracking-[0.2em] shadow-2xl active:scale-[0.98] transition-all hover:bg-black">
                        Save Entry
                    </button>
                </form>
            </div>
        </div>

        <div id="tab-analysis" class="tab-content">
            <div class="space-y-6">
                <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-white">
                    <h3 class="text-[10px] font-black text-slate-400 mb-6 text-center uppercase tracking-[0.2em]">Monthly Trends</h3>
                    <div class="h-64"><canvas id="barChart"></canvas></div>
                </div>
                <div class="bg-white p-6 rounded-[2.5rem] shadow-xl border border-white">
                    <h3 class="text-[10px] font-black text-slate-400 mb-2 text-center uppercase tracking-[0.2em]">Case Distribution</h3>
                    <p class="text-[9px] text-blue-500 font-bold text-center mb-6 bg-blue-50 py-1 rounded-full italic">Interactive Chart: Click segments for details</p>
                    <div class="h-64"><canvas id="pieChart"></canvas></div>
                    <div id="caseDetails" class="mt-8 hidden animate-fadeIn">
                        <div class="flex justify-between items-center border-b border-slate-100 pb-3 mb-4">
                            <h4 id="detailTitle" class="text-sm font-black text-slate-800">DETAILS</h4>
                            <button onclick="document.getElementById('caseDetails').classList.add('hidden')" class="bg-slate-100 text-slate-400 p-2 rounded-full text-[10px]">‚úï</button>
                        </div>
                        <div id="detailList" class="space-y-3 max-h-80 overflow-y-auto"></div>
                    </div>
                </div>
            </div>
        </div>

        <div id="tab-list" class="tab-content">
            <div class="bg-slate-900 p-6 rounded-[2.5rem] shadow-2xl mb-6 space-y-4 border border-slate-800">
                <div class="flex justify-between items-center">
                    <p class="text-[10px] font-black text-blue-400 uppercase tracking-widest">Filter Records</p>
                    <button onclick="clearSearch()" class="text-[10px] font-bold text-slate-500 hover:text-white transition">Reset</button>
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input type="date" id="qStart" class="bg-slate-800 border-0 text-white p-3 rounded-xl text-xs text-center font-bold">
                    <input type="date" id="qEnd" class="bg-slate-800 border-0 text-white p-3 rounded-xl text-xs text-center font-bold">
                </div>
                <div class="grid grid-cols-2 gap-3">
                    <input type="text" id="qClient" placeholder="CLIENT ID" class="bg-slate-800 border-0 text-white p-3 rounded-xl text-xs text-center font-bold placeholder:text-slate-600 font-mono">
                    <input type="text" id="qCase" placeholder="CASE NO." class="bg-slate-800 border-0 text-white p-3 rounded-xl text-xs text-center font-bold placeholder:text-slate-600 font-mono">
                </div>
                <div class="flex gap-3">
                    <button onclick="updateUI()" class="flex-grow bg-blue-600 hover:bg-blue-500 text-white py-3 rounded-xl text-xs font-black uppercase tracking-widest transition shadow-lg shadow-blue-900/20">Apply Filters</button>
                    <button onclick="exportCSV()" class="bg-slate-700 hover:bg-slate-600 text-white px-5 rounded-xl font-bold text-xs transition">CSV</button>
                </div>
            </div>
            <div id="logContainer" class="space-y-4"></div>
        </div>
    </div>

    <div id="nameModal" class="modal">
        <div class="modal-content text-center space-y-5 border-4 border-blue-50 shadow-2xl">
            <div class="bg-blue-50 w-16 h-16 rounded-3xl flex items-center justify-center mx-auto mb-2">
                <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="#2563eb" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
            </div>
            <div>
                <h3 class="font-black text-slate-800 text-lg uppercase tracking-tight">New Relation</h3>
                <p id="modalHint" class="text-xs text-slate-400 font-medium px-4"></p>
            </div>
            <input type="text" id="newNameInput" class="w-full border-2 border-slate-100 p-4 rounded-2xl text-center font-black text-slate-700 focus:border-blue-500 outline-none shadow-inner bg-slate-50" placeholder="Enter Name...">
            <button onclick="saveNewName()" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-black shadow-xl shadow-blue-200 active:scale-95 transition-all">Confirm</button>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white/90 backdrop-blur-md border-t border-slate-100 flex justify-around p-4 shadow-[0_-20px_40px_rgba(0,0,0,0.05)] z-50 h-28">
        <button onclick="switchTab('form')" id="btn-form" class="nav-btn active-tab-btn">
            <span class="text-[10px] font-black uppercase tracking-[0.2em]">Enter</span>
        </button>
        <button onclick="switchTab('analysis')" id="btn-analysis" class="nav-btn text-slate-400">
            <span class="text-[10px] font-black uppercase tracking-[0.2em]">Stats</span>
        </button>
        <button onclick="switchTab('list')" id="btn-list" class="nav-btn text-slate-400">
            <span class="text-[10px] font-black uppercase tracking-[0.2em]">Vault</span>
        </button>
    </div>

    <script>
        // ÊâÄÊúâÈÇèËºØ‰øùÊåÅ‰∏çËÆäÔºåÁ¢∫‰øùÂäüËÉΩÂÆåÊï¥ÊÄß
        const DB_KEY = 'work_logs_final';
        const META_KEY = 'meta_data_v4';

        function forceRefresh() {
            const btn = document.getElementById('refreshBtn');
            btn.classList.add('spinning');
            const newUrl = window.location.href.split('?')[0] + '?t=' + new Date().getTime();
            setTimeout(() => { window.location.replace(newUrl); }, 600);
        }

        function getLogs() {
            let data = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            ['work_logs', 'work_logs_v2', 'work_logs_v3'].forEach(k => {
                let old = JSON.parse(localStorage.getItem(k) || '[]');
                old.forEach(ol => {
                    if(!data.some(nl => nl.id === ol.id)) {
                        if(!ol.sd) ol.sd = ol.date || new Date().toISOString().split('T')[0].replace(/-/g,'/');
                        if(!ol.ed) ol.ed = ol.sd;
                        data.push(ol);
                    }
                });
            });
            data.sort((a, b) => b.id - a.id);
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            return data;
        }

        let logs = getLogs();
        let meta = JSON.parse(localStorage.getItem(META_KEY) || '{"clients":{}, "cases":{}}');
        let currentModalTarget = null;
        let pieChart, barChart;

        function init() {
            const today = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = today;
            document.getElementById('endDate').value = today;
            renderTopThree();
            updateUI();
        }

        document.getElementById('clientId').addEventListener('blur', function() {
            const id = this.value.trim(); if(!id) return;
            if(meta.clients[id]) document.getElementById('clientName').value = meta.clients[id];
            else openModal('client', id);
        });
        document.getElementById('caseId').addEventListener('blur', function() {
            const id = this.value.trim(); if(!id) return;
            if(meta.cases[id]) {
                document.getElementById('matterName').value = meta.cases[id];
                const hist = logs.find(l => l.cn === id);
                if(hist) document.getElementById('caseType').value = hist.ct;
            } else openModal('case', id);
        });

        function openModal(type, id) {
            currentModalTarget = { type, id };
            document.getElementById('modalHint').innerHTML = `Add relation for ID: <b class="text-blue-600">${id}</b>`;
            document.getElementById('nameModal').style.display = 'block';
        }

        function saveNewName() {
            const name = document.getElementById('newNameInput').value.trim();
            if(!name) return;
            if(currentModalTarget.type === 'client') { meta.clients[currentModalTarget.id] = name; document.getElementById('clientName').value = name; }
            else { meta.cases[currentModalTarget.id] = name; document.getElementById('matterName').value = name; }
            localStorage.setItem(META_KEY, JSON.stringify(meta));
            document.getElementById('nameModal').style.display = 'none';
            document.getElementById('newNameInput').value = '';
        }

        function renderTopThree() {
            const sevenDaysAgo = Date.now() - (7 * 24 * 60 * 60 * 1000);
            const freq = {};
            logs.filter(l => l.id > sevenDaysAgo).forEach(l => { const key = `${l.c}|${l.cn}`; freq[key] = (freq[key] || 0) + 1; });
            const top3 = Object.entries(freq).sort((a,b) => b[1] - a[1]).slice(0,3);
            const container = document.getElementById('topFrequency');
            if(top3.length === 0) { container.innerHTML = ""; return; }
            container.innerHTML = top3.map(([key]) => {
                const [cid, mid] = key.split('|');
                return `<div onclick="applyQuick('${cid}','${mid}')" class="bg-white text-slate-800 text-[10px] px-5 py-3 rounded-2xl whitespace-nowrap shadow-sm border border-slate-100 active:scale-95 transition font-black uppercase tracking-tighter">üî• ${mid}</div>`;
            }).join('');
        }

        function applyQuick(cid, mid) {
            document.getElementById('clientId').value = cid;
            document.getElementById('caseId').value = mid;
            document.getElementById('clientName').value = meta.clients[cid] || "";
            document.getElementById('matterName').value = meta.cases[mid] || "";
            const hist = logs.find(l => l.cn === mid);
            if(hist) document.getElementById('caseType').value = hist.ct;
            calc();
        }

        function updateUI() {
            const container = document.getElementById('logContainer');
            const qs = document.getElementById('qStart').value, qe = document.getElementById('qEnd').value;
            const qc = document.getElementById('qClient').value.trim(), qn = document.getElementById('qCase').value.trim();
            const filtered = logs.filter(l => {
                const dateMatch = (!qs || l.sd.replace(/\//g,'-') >= qs) && (!qe || l.sd.replace(/\//g,'-') <= qe);
                const clientMatch = !qc || l.c.includes(qc);
                const caseMatch = !qn || l.cn.includes(qn);
                return dateMatch && clientMatch && caseMatch;
            });
            container.innerHTML = filtered.map(l => `
                <div class="bg-white p-5 rounded-[2rem] border border-white shadow-lg relative group overflow-hidden">
                    <div class="absolute left-0 top-0 bottom-0 w-1.5 bg-blue-600 opacity-20"></div>
                    <div class="flex justify-between items-start relative z-10">
                        <div class="space-y-1.5">
                            <p class="text-[10px] text-blue-600 font-black tracking-widest uppercase">${l.sd} ‚Ä¢ ${l.s} - ${l.e}</p>
                            <h3 class="font-extrabold text-slate-900 text-sm">${l.c} <span class="font-medium text-slate-400 text-xs ml-1">${meta.clients[l.c]||''}</span></h3>
                            <p class="text-xs text-slate-500 font-bold">${l.cn} <span class="text-slate-300 mx-1">|</span> <span class="text-slate-400 font-medium">${meta.cases[l.cn]||''}</span></p>
                            <div class="flex gap-2 pt-1">
                                <span class="text-[9px] font-black bg-blue-50 text-blue-600 px-2.5 py-1 rounded-full uppercase">${l.ct}</span>
                                <span class="text-[9px] font-black bg-slate-50 text-slate-500 px-2.5 py-1 rounded-full uppercase">${l.wc}</span>
                            </div>
                        </div>
                        <div class="text-right">
                            <p class="text-2xl font-black text-slate-900 font-mono tracking-tighter">${l.h.toFixed(1)}</p>
                            <div class="flex gap-1.5 mt-4">
                                <button onclick="editLog(${l.id})" class="bg-blue-50 text-blue-600 p-2.5 rounded-xl text-[10px] font-black uppercase tracking-tighter active:scale-90 transition">Edit</button>
                                <button onclick="deleteLog(${l.id})" class="bg-red-50 text-red-400 p-2.5 rounded-xl text-[10px] font-black uppercase tracking-tighter active:scale-90 transition">Del</button>
                            </div>
                        </div>
                    </div>
                </div>
            `).join('');
            const today = new Date().toISOString().split('T')[0].replace(/-/g, '/');
            const dayTotal = logs.filter(l => l.sd === today).reduce((a, b) => a + b.h, 0);
            document.getElementById('navDayTotal').innerText = dayTotal.toFixed(1);
        }

        function editLog(id) {
            const l = logs.find(log => log.id === id); if(!l) return;
            document.getElementById('clientId').value = l.c; document.getElementById('clientName').value = meta.clients[l.c] || '';
            document.getElementById('caseId').value = l.cn; document.getElementById('matterName').value = meta.cases[l.cn] || '';
            document.getElementById('startDate').value = l.sd.replace(/\//g, '-'); document.getElementById('endDate').value = l.ed.replace(/\//g, '-');
            document.getElementById('startTime').value = l.s; document.getElementById('endTime').value = l.e;
            document.getElementById('content').value = l.desc; document.getElementById('caseType').value = l.ct; document.getElementById('workCode').value = l.wc;
            logs = logs.filter(log => log.id !== id); switchTab('form'); calc();
        }

        function calc() {
            const d1 = document.getElementById('startDate').value, t1 = document.getElementById('startTime').value;
            const d2 = document.getElementById('endDate').value, t2 = document.getElementById('endTime').value;
            if(d1 && t1 && d2 && t2) {
                const start = new Date(`${d1}T${t1}`), end = new Date(`${d2}T${t2}`);
                let diff = (end - start) / 60000;
                document.getElementById('hours').value = diff >= 0 ? (Math.ceil(diff / 6) / 10).toFixed(1) : "Error";
            }
        }
        ['startDate', 'startTime', 'endDate', 'endTime'].forEach(id => document.getElementById(id).onchange = calc);

        document.getElementById('timeForm').onsubmit = (e) => {
            e.preventDefault();
            const h = parseFloat(document.getElementById('hours').value);
            if(isNaN(h)) return alert('ÊôÇÈñìË®≠ÂÆö‰∏çÊ≠£Á¢∫');
            const log = {
                id: Date.now(), sd: document.getElementById('startDate').value.replace(/-/g, '/'),
                ed: document.getElementById('endDate').value.replace(/-/g, '/'),
                s: document.getElementById('startTime').value, e: document.getElementById('endTime').value,
                h: h, c: document.getElementById('clientId').value.trim(), cn: document.getElementById('caseId').value.trim(),
                wc: document.getElementById('workCode').value, ct: document.getElementById('caseType').value, desc: document.getElementById('content').value.trim()
            };
            logs.unshift(log); localStorage.setItem(DB_KEY, JSON.stringify(logs));
            init(); switchTab('list');
        };

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            document.querySelectorAll('.nav-btn').forEach(b => { b.classList.remove('active-tab-btn'); b.classList.add('text-slate-400'); });
            const activeBtn = document.getElementById('btn-' + t);
            activeBtn.classList.add('active-tab-btn'); activeBtn.classList.remove('text-slate-400');
            if(t === 'analysis') renderCharts();
            updateUI();
        }

        function deleteLog(id) { if(confirm('Confirm Delete?')) { logs = logs.filter(l => l.id !== id); localStorage.setItem(DB_KEY, JSON.stringify(logs)); updateUI(); } }

        function renderCharts() {
            if (pieChart) pieChart.destroy(); if (barChart) barChart.destroy();
            const caseMap = {}; logs.forEach(l => { if(l.cn) caseMap[l.cn] = l.ct; });
            const typeCounts = {}; Object.values(caseMap).forEach(t => typeCounts[t] = (typeCounts[t]||0)+1);
            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'doughnut', // ÊîπÁÇ∫Áí∞ÂΩ¢ÂúñÊõ¥ÊúâË®≠Ë®àÊÑü
                data: {
                    labels: Object.keys(typeCounts),
                    datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#3b82f6','#6366f1','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899'], borderWidth: 4, borderColor: '#ffffff' }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, cutout: '70%',
                    onClick: (evt, elements) => { if (elements.length > 0) showCategoryDetails(pieChart.data.labels[elements[0].index]); },
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 8, usePointStyle: true, font: { size: 10, weight: 'bold' } } } }
                }
            });
            const monthData = {}; logs.forEach(l => { const m = l.sd.substring(0, 7); monthData[m] = (monthData[m]||0)+l.h; });
            const sorted = Object.keys(monthData).sort();
            barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar',
                data: { labels: sorted, datasets: [{ label: 'Total Hours', data: sorted.map(m=>monthData[m]), backgroundColor: '#3b82f6', borderRadius: 12, barThickness: 20 }] },
                options: { 
                    responsive: true, maintainAspectRatio: false, 
                    scales: { y: { beginAtZero: true, grid: { display: false } }, x: { grid: { display: false } } },
                    plugins: { legend: { display: false } } 
                }
            });
        }

        function showCategoryDetails(category) {
            const detailsDiv = document.getElementById('caseDetails');
            const listDiv = document.getElementById('detailList');
            const uniqueCases = new Set(); logs.filter(l => l.ct === category).forEach(l => uniqueCases.add(`${l.c} | ${l.cn}`));
            document.getElementById('detailTitle').innerText = category.toUpperCase();
            listDiv.innerHTML = Array.from(uniqueCases).map(item => {
                const [cid, mid] = item.split(' | ');
                return `<div class="bg-slate-50 p-4 rounded-2xl flex justify-between items-center border border-slate-100"><div class="text-[10px] font-black text-slate-400 uppercase">ID: ${cid}<br><span class="text-sm text-slate-800 font-extrabold tracking-tight">${mid}</span></div><div class="text-[10px] text-blue-600 font-black">${meta.cases[mid] || ''}</div></div>`;
            }).join('');
            detailsDiv.classList.remove('hidden'); detailsDiv.scrollIntoView({ behavior: 'smooth' });
        }

        function exportCSV() {
            let csv = "\uFEFFÈñãÂßãÊó•Êúü,ÁµêÊùüÊó•Êúü,ÂÆ¢Êà∂ID,ÂÆ¢Êà∂ÂêçÁ®±,Ê°àËôü,Ê°à‰ª∂ÂêçÁ®±,Â∞èÊôÇ,WorkCode,È°ûÂà•,ÂÖßÂÆπ\n";
            logs.forEach(l => { csv += `${l.sd},${l.ed},${l.c},${meta.clients[l.c]||''},${l.cn},${meta.cases[l.cn]||''},${l.h},${l.wc},${l.ct},"${(l.desc||'').replace(/"/g,'""')}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob); link.download = `WorkLog_Export.csv`; link.click();
        }

        function clearSearch() { ['qStart','qEnd','qClient','qCase'].forEach(id => document.getElementById(id).value = ''); updateUI(); }

        init();
    </script>
</body>
</html>
