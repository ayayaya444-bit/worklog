<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>工作紀錄 Pro 置中優化版</title>
    <meta name="apple-mobile-web-app-capable" content="yes">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: -apple-system, BlinkMacSystemFont, sans-serif; background-color: #f8fafc; }
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        .active-tab-btn { color: #2563eb !important; border-top: 2px solid #2563eb; }
        /* 強制日期與時間選取器在 iOS 上置中 */
        input[type="date"], input[type="time"] {
            text-align: center;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        input, select, textarea { font-size: 16px !important; }
    </style>
</head>
<body class="pb-24">

    <nav class="bg-slate-900 text-white p-4 sticky top-0 z-50 shadow-md flex justify-between items-center">
        <div>
            <h1 class="text-lg font-bold">工作紀錄系統</h1>
            <p class="text-[10px] opacity-60">介面對齊優化完成</p>
        </div>
        <div class="text-right">
            <p class="text-xs opacity-70">今日累積</p>
            <p class="text-xl font-mono text-blue-400" id="navDayTotal">0.0</p>
        </div>
    </nav>

    <div class="p-4 max-w-md mx-auto">
        <div id="tab-form" class="tab-content active">
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-200">
                <form id="timeForm" class="space-y-4">
                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">CLIENT ID</label>
                            <input type="text" id="clientId" list="clientHistory" required class="w-full bg-slate-50 border-0 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 text-center" placeholder="客戶編號">
                            <datalist id="clientHistory"></datalist>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">CASE NO.</label>
                            <input type="text" id="caseId" required class="w-full bg-slate-50 border-0 rounded-xl p-3 focus:ring-2 focus:ring-blue-500 text-center" placeholder="案號">
                        </div>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-2xl border border-blue-100">
                        <label class="block text-xs font-bold text-blue-600 mb-2 text-center">START 開始時間</label>
                        <div class="space-y-2">
                            <input type="date" id="startDate" required class="w-full bg-white border-0 rounded-xl p-3 text-sm font-bold shadow-sm text-center">
                            <input type="time" id="startTime" required class="w-full bg-white border-0 rounded-xl p-3 text-sm shadow-sm text-center">
                        </div>
                    </div>

                    <div class="bg-indigo-50 p-4 rounded-2xl border border-indigo-100">
                        <label class="block text-xs font-bold text-indigo-600 mb-2 text-center">END 結束時間</label>
                        <div class="space-y-2">
                            <input type="date" id="endDate" required class="w-full bg-white border-0 rounded-xl p-3 text-sm font-bold shadow-sm text-center">
                            <input type="time" id="endTime" required class="w-full bg-white border-0 rounded-xl p-3 text-sm shadow-sm text-center">
                        </div>
                    </div>

                    <div>
                        <label class="block text-xs font-bold text-slate-500 mb-1 text-center">TOTAL HOURS</label>
                        <input type="text" id="hours" readonly class="w-full bg-blue-100 text-blue-700 font-black border-0 rounded-xl p-3 text-center text-xl">
                    </div>

                    <div class="grid grid-cols-2 gap-3">
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">WORK CODE</label>
                            <select id="workCode" class="w-full bg-slate-50 border-0 rounded-xl p-3 text-sm text-center">
                                <option value="D">D</option><option value="RW">RW</option><option value="CF">CF</option>
                            </select>
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-slate-500 mb-1">TYPE</label>
                            <select id="caseType" class="w-full bg-slate-50 border-0 rounded-xl p-3 text-sm text-center">
                                <option>M&A</option><option>General Corporate</option><option>Corporate Financing</option>
                                <option>Project Financing</option><option>Bond Issuance</option><option>Formosa Bond</option>
                                <option>金融商品</option><option>投信投顧</option><option>PE Fund</option>
                                <option>金融機構併購</option><option>個人資料保護</option><option>其他</option>
                            </select>
                        </div>
                    </div>

                    <textarea id="content" rows="2" class="w-full bg-slate-50 border-0 rounded-xl p-3 text-sm" placeholder="工作內容..."></textarea>
                    <button type="submit" class="w-full bg-blue-600 text-white py-4 rounded-2xl font-bold shadow-lg active:scale-95 transition">儲存紀錄</button>
                </form>
            </div>
        </div>

        <div id="tab-analysis" class="tab-content">
            <div class="space-y-6">
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 text-center">每月總工時趨勢</h3>
                    <div class="h-64"><canvas id="barChart"></canvas></div>
                </div>
                <div class="bg-white p-4 rounded-2xl shadow-sm border border-slate-200">
                    <h3 class="text-sm font-bold text-slate-700 mb-4 text-center">案件類型分佈</h3>
                    <div class="h-64"><canvas id="pieChart"></canvas></div>
                </div>
            </div>
        </div>

        <div id="tab-list" class="tab-content">
            <div class="flex gap-2 mb-4">
                <input type="text" id="searchInput" placeholder="搜尋..." class="flex-grow p-3 rounded-xl border-0 shadow-sm text-sm">
                <button onclick="exportCSV()" class="bg-emerald-600 text-white px-4 rounded-xl font-bold text-xs">CSV</button>
            </div>
            <div id="logContainer" class="space-y-3"></div>
        </div>
    </div>

    <div class="fixed bottom-0 left-0 right-0 bg-white border-t border-slate-200 flex justify-around py-3 shadow-lg z-50">
        <button onclick="switchTab('form')" id="btn-form" class="flex flex-col items-center px-6 active-tab-btn"><span class="text-xs font-bold">紀錄</span></button>
        <button onclick="switchTab('analysis')" id="btn-analysis" class="flex flex-col items-center px-6 text-slate-400"><span class="text-xs font-bold">分析</span></button>
        <button onclick="switchTab('list')" id="btn-list" class="flex flex-col items-center px-6 text-slate-400"><span class="text-xs font-bold">清單</span></button>
    </div>

    <script>
        const DB_KEY = 'work_logs_final';
        const CLIENT_KEY = 'clients_v3';

        function getLogs() {
            let data = JSON.parse(localStorage.getItem(DB_KEY) || '[]');
            ['work_logs', 'work_logs_v2', 'work_logs_v3'].forEach(k => {
                let old = JSON.parse(localStorage.getItem(k) || '[]');
                old.forEach(ol => { if(!data.some(nl => nl.id === ol.id)) data.push(ol); });
            });
            data = data.map(l => {
                if(!l.sd) l.sd = l.date || new Date().toISOString().split('T')[0].replace(/-/g,'/');
                if(!l.ed) l.ed = l.sd;
                return l;
            });
            data.sort((a, b) => b.id - a.id);
            localStorage.setItem(DB_KEY, JSON.stringify(data));
            return data;
        }

        let logs = getLogs();
        let clients = JSON.parse(localStorage.getItem(CLIENT_KEY) || '[]');
        let pieChart, barChart;

        function initDates() {
            const now = new Date().toISOString().split('T')[0];
            document.getElementById('startDate').value = now;
            document.getElementById('endDate').value = now;
            updateClientDatalist();
        }

        function updateClientDatalist() {
            document.getElementById('clientHistory').innerHTML = clients.map(c => `<option value="${c}">`).join('');
        }

        function switchTab(t) {
            document.querySelectorAll('.tab-content').forEach(e => e.classList.remove('active'));
            document.getElementById('tab-' + t).classList.add('active');
            document.querySelectorAll('button[id^="btn-"]').forEach(b => {
                b.classList.remove('active-tab-btn');
                b.classList.add('text-slate-400');
            });
            const activeBtn = document.getElementById('btn-' + t);
            activeBtn.classList.add('active-tab-btn');
            activeBtn.classList.remove('text-slate-400');
            if(t === 'analysis') renderCharts();
            if(t === 'list') updateUI();
        }

        document.getElementById('caseId').oninput = function() {
            const found = logs.find(l => l.cn === this.value.trim());
            document.getElementById('caseType').value = found ? found.ct : "M&A";
        };

        function calc() {
            const d1 = document.getElementById('startDate').value, t1 = document.getElementById('startTime').value;
            const d2 = document.getElementById('endDate').value, t2 = document.getElementById('endTime').value;
            if(d1 && t1 && d2 && t2) {
                const start = new Date(`${d1}T${t1}`), end = new Date(`${d2}T${t2}`);
                let diff = (end - start) / 60000;
                document.getElementById('hours').value = diff >= 0 ? (Math.ceil(diff / 6) / 10).toFixed(1) : "時間錯誤";
            }
        }
        ['startDate', 'startTime', 'endDate', 'endTime'].forEach(id => document.getElementById(id).onchange = calc);

        document.getElementById('timeForm').onsubmit = (e) => {
            e.preventDefault();
            const h = parseFloat(document.getElementById('hours').value);
            if(isNaN(h)) return alert('請確認日期時間');
            const clientVal = document.getElementById('clientId').value.trim();
            const log = {
                id: Date.now(),
                sd: document.getElementById('startDate').value.replace(/-/g, '/'),
                ed: document.getElementById('endDate').value.replace(/-/g, '/'),
                s: document.getElementById('startTime').value,
                e: document.getElementById('endTime').value,
                h: h,
                c: clientVal,
                cn: document.getElementById('caseId').value.trim(),
                wc: document.getElementById('workCode').value,
                ct: document.getElementById('caseType').value,
                desc: document.getElementById('content').value.trim()
            };
            if(clientVal && !clients.includes(clientVal)) {
                clients.push(clientVal);
                localStorage.setItem(CLIENT_KEY, JSON.stringify(clients));
            }
            logs.unshift(log);
            localStorage.setItem(DB_KEY, JSON.stringify(logs));
            alert('儲存成功'); e.target.reset(); initDates(); updateUI();
        };

        function updateUI() {
            const container = document.getElementById('logContainer');
            const search = document.getElementById('searchInput').value.toLowerCase();
            const filtered = logs.filter(l => l.c.toLowerCase().includes(search) || l.cn.toLowerCase().includes(search) || l.desc.toLowerCase().includes(search));
            container.innerHTML = filtered.map(l => `
                <div class="bg-white p-4 rounded-xl border mb-3 relative shadow-sm">
                    <button onclick="deleteLog(${l.id})" class="absolute top-2 right-3 text-slate-300">✕</button>
                    <div class="flex justify-between items-start">
                        <div>
                            <p class="text-[10px] text-blue-600 font-black mb-1">${l.sd} ${l.s} → ${l.ed === l.sd ? '' : l.ed.split('/').slice(1).join('/')} ${l.e}</p>
                            <h3 class="font-bold text-slate-800 text-base">${l.c}</h3>
                            <p class="text-xs text-slate-500 font-medium">${l.cn} <span class="ml-2 text-[10px] bg-slate-100 px-1 rounded">${l.ct}</span></p>
                        </div>
                        <div class="text-right"><p class="text-xl font-black text-slate-900">${l.h.toFixed(1)}</p></div>
                    </div>
                    ${l.desc ? `<p class="text-[11px] text-slate-500 mt-2 bg-slate-50 p-2 rounded border-l-2 border-slate-200">${l.desc}</p>` : ''}
                </div>
            `).join('');
            const todayStr = new Date().toISOString().split('T')[0].replace(/-/g, '/');
            const dayTotal = logs.filter(l => l.sd === todayStr).reduce((a, b) => a + b.h, 0);
            document.getElementById('navDayTotal').innerText = dayTotal.toFixed(1);
        }

        function deleteLog(id) {
            if(confirm('確定刪除？')) { logs = logs.filter(l => l.id !== id); localStorage.setItem(DB_KEY, JSON.stringify(logs)); updateUI(); }
        }

        function renderCharts() {
            if (pieChart) pieChart.destroy(); if (barChart) barChart.destroy();
            const caseMap = {}; logs.forEach(l => { if(l.cn) caseMap[l.cn] = l.ct; });
            const typeCounts = {}; Object.values(caseMap).forEach(t => typeCounts[t] = (typeCounts[t]||0)+1);
            pieChart = new Chart(document.getElementById('pieChart'), {
                type: 'pie', data: { labels: Object.keys(typeCounts), datasets: [{ data: Object.values(typeCounts), backgroundColor: ['#3b82f6','#10b981','#f59e0b','#ef4444','#8b5cf6','#ec4899','#64748b'] }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
            const monthData = {}; logs.forEach(l => { const m = l.sd.substring(0, 7); monthData[m] = (monthData[m]||0)+l.h; });
            const sorted = Object.keys(monthData).sort();
            barChart = new Chart(document.getElementById('barChart'), {
                type: 'bar', data: { labels: sorted, datasets: [{ label: '工時', data: sorted.map(m=>monthData[m]), backgroundColor: '#6366f1' }] },
                options: { responsive: true, maintainAspectRatio: false }
            });
        }

        function exportCSV() {
            let csv = "\uFEFF開始日期,結束日期,客戶,案號,小時,WorkCode,類別,內容\n";
            logs.forEach(l => { csv += `${l.sd},${l.ed},${l.c},${l.cn},${l.h},${l.wc},${l.ct},"${l.desc.replace(/"/g,'""')}"\n`; });
            const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            link.href = URL.createObjectURL(blob);
            link.download = `WorkLog_Export.csv`;
            link.click();
        }

        document.getElementById('searchInput').oninput = updateUI;
        initDates();
        updateUI();
    </script>
</body>
</html>
